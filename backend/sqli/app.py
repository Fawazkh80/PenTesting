from typing import Union
from fastapi import FastAPI, Request, Body
import psycopg2, json, time
from fastapi.middleware.cors import CORSMiddleware


app = FastAPI()


origins = ["*"]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
while True:
    try:
        conn = psycopg2.connect(
        database="sqli", user='root', password='root', host='db', port= '5432'
        )
        print("Connected to PostgreSQL database")
        break
    except psycopg2.OperationalError as e:
        print("Connection failed:", e)
        print("Retrying in 5 seconds...")
        time.sleep(5)
#establishing the connection

cursor = conn.cursor()
sql ='''CREATE TABLE IF NOT EXISTS client(
   name VARCHAR(200),
   email VARCHAR(200),
   password VARCHAR(200)
   
)'''
cursor.execute(sql)
print("Table created successfully........")
conn.commit()

sql = f''' 
    insert into client (
name, email, password) 
values('Client 1', 'Client1@hotmail.com', '1_Cli1ent#1')
'''
cursor.execute(sql)
conn.commit()

@app.post("/secure")
def secure(req: Request):
    return{}

@app.post("/vulnerable")
async def vulnerable(req: Request):
    request = await req.json()
    print(json.dumps(request))
    cursor.execute(f"SELECT * from client WHERE  name='{request['name']}' OR email='{request['email']}' OR password='{request['password']}'")
    # cursor.execute(f"SELECT * from client")

    result = cursor.fetchone()

    return result